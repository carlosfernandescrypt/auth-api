function verificar_login_api() {
    // Páginas protegidas por login
    $paginas_protegidas = [1737, 1751, 1746]; // IDs ou slugs das páginas protegidas
    
    if (current_user_can('administrator')) {
        return;
    }
    
    if (is_page($paginas_protegidas)) {
        ?>
        <script>
          // Verificar se o token JWT existe
          const token = localStorage.getItem("token");

          if (!token) {
              // Redirecionar para a página de login se o token não estiver presente
              window.location.href = "https://areacliente.oneelevadores.com.br/login";
          }
        </script>
        <?php
    }
}
add_action('wp_footer', 'verificar_login_api');


function verificar_login_e_token_com_api() {
    $paginas_protegidas = [1737, 1751, 1746];
    if (current_user_can('administrator')) {
        return;
    }

    if (is_page($paginas_protegidas)) {
        ?>
        <script>
          async function verificarToken() {
              const token = localStorage.getItem("token");
              if (!token) {
                  window.location.href = "https://areacliente.oneelevadores.com.br/login";
                  return;
              }

              try {
                  const response = await fetch("https://8aab-179-124-14-78.ngrok-free.app/api/auth/verify", {
                      method: "POST",
                      headers: { "Authorization": `Bearer ${token}` }
                  });

                  if (!response.ok) {
                      localStorage.removeItem("token"); // Remove token inválido
                      window.location.href = "https://areacliente.oneelevadores.com.br/login"; // Redireciona para login
                  }
              } catch (error) {
                  console.error("Erro ao verificar o token:", error);
                  window.location.href = "https://areacliente.oneelevadores.com.br/login";
              }
          }

          verificarToken();
        </script>
        <?php
    }
}
add_action('wp_footer', 'verificar_login_e_token_com_api');
